name: Release APK (tagged)

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      # NOTE: We avoid step-level `if:` expressions referencing `secrets.*` because
      # GitHub can mark the workflow as invalid in forks ("Unrecognized named-value: 'secrets'").
      # Instead, we check the env var at runtime.
      - name: Decode signing keystore (optional)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          if [ -n "${ANDROID_KEYSTORE_BASE64}" ]; then
            mkdir -p "$HOME/.keystore"
            echo "${ANDROID_KEYSTORE_BASE64}" | base64 -d > "$HOME/.keystore/release.jks"
          else
            echo "ANDROID_KEYSTORE_BASE64 not set; building unsigned release APK."
          fi

      - name: Configure Gradle signing (optional)
        shell: bash
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "${ANDROID_KEYSTORE_BASE64}" ]; then
            mkdir -p "$HOME/.gradle"
            cat >> "$HOME/.gradle/gradle.properties" <<EOF
            signingStoreLocation=$HOME/.keystore/release.jks
            signingStorePassword=${SIGNING_STORE_PASSWORD}
            signingKeyAlias=${SIGNING_KEY_ALIAS}
            signingKeyPassword=${SIGNING_KEY_PASSWORD}
            EOF
          fi

      - name: Build release APK (signed if secrets provided)
        run: ./gradlew :app:assembleRelease --no-daemon

      - name: Select APK artifact
        id: apk
        shell: bash
        run: |
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "path=app/build/outputs/apk/release/app-release.apk" >> $GITHUB_OUTPUT
          else
            echo "path=app/build/outputs/apk/release/app-release-unsigned.apk" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release + upload APK
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: false
          files: |
            ${{ steps.apk.outputs.path }}

      - name: Delete older releases (keep latest 3)
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}



